Librame.Extensions Series
=========================

[![License](https://img.shields.io/badge/license-MIT-orange.svg)](https://github.com/librame/extensions/blob/master/LICENSE)
[![Available on NuGet https://www.nuget.org/packages?q=Librame.Extensions](https://img.shields.io/nuget/v/Librame.Extensions.svg?style=flat-square)](https://www.nuget.org/packages?q=Librame.Extensions)
[![Join the chat at https://gitter.im/librame/extensions](https://img.shields.io/gitter/room/librame/extensions.js.svg?style=flat-square)](https://gitter.im/librame/extensions?utm_source=badge&utm_medium=badge&utm_campaign=pr-badge&utm_content=badge)

English | [简体中文](/README.md)

### A new [LibrameTick.Extensions](https://github.com/librame/extensions-tick) framework for.NET 6 is now available.

Librame.Extensions is a library of basic tools series based on the .NET Standard/Framework, including Core, Data, Drawing, Encryption, Network, Storage, and more.

| Libraries                                    | .NET Standard 2.1  | .NET Framework 4.8     |
|--------------------------------------------  |------------------  |----------------------  |
| Librame.Extensions.Core                      | ✓                  | ✓                      |
| Librame.Extensions.Data.EntityFrameworkCore  | ✓                  | ! compatible           |
| Librame.Extensions.Drawing.SkiaSharp         | ✓                  | ! compiled to x86/x64  |
| Librame.Extensions.Encryption                | ✓                  | ✓                      |
| Librame.Extensions.Network                   | ✓                  | ✓                      |
| Librame.Extensions.Network.DotNetty          | ✓                  | ✓                      |
| Librame.Extensions.Storage                   | ✓                  | ✓                      |

## Get Started

Librame.Extensions APIs can then be added to the project using the NuGet Package Manager. Official releases are on [NuGet](https://www.nuget.org/packages?q=Librame.Extensions).

## Features

Librame.Extensions.Core (and Core.Abstractions)

- [x] Identifiers: SequentialUniqueIdentifier, SnowflakeIdentifier (Core.Abstractions)
- [x] Localizers (Extended support for lambda expression)
- [x] Mediators (Based on MediatR)
- [x] Services: Clock, Humanization, Injection

Librame.Extensions.Data.EntityFrameworkCore (and Data.Abstractions)

- [x] Accessors (DbContextAccessor): multi-tenancy, writing separation, data migration, data audit, entity/table Management
- [x] Collections: IPageable, ITreeable (Data.Abstractions)
- [x] Stores: GuidStoreIdentifierGenerator, GuidStoreInitializer, StoreHub

Librame.Extensions.Drawing.SkiaSharp (and Drawing.Abstractions)

- [x] Services: Captcha, Scale, Watermark

Librame.Extensions.Encryption (and Encryption.Abstractions)

- [x] Services: Hash, KeyedHash, Rsa, Symmetric
- [x] SigningCredentials (Support for temporary key files generated by IdentityServer4)

Librame.Extensions.Network (and Network.Abstractions)

- [x] Requesters: HttpClient, HttpWebRequest
- [x] Services: Crawler, Email, Sms

Librame.Extensions.Network.DotNetty

- [x] Demo (Based on DotNetty): Discard, Echo, Factorial, HttpServer, QuoteOfTheMoment, SecureChat, Telnet, WebSocket

Librame.Extensions.Storage (and Storage.Abstractions)

- [x] Capacities: Binary, Decimal (Storage.Abstractions)
- [x] Services: PhysicalStorageFile (Read/Write), FileTransfer (Download/Upload), FilePermission (AccessToken/AuthorizationCode/CookieValue)

## How to use

Take Librame.Extensions.Data.EntityFrameworkCore as an example:

    PM> Install-Package: Librame.Extensions.Data.EntityFrameworkCore

### Configuration

    // appsettings.json
    {
        // Test1: SQLite
        "ConnectionStrings": {
            "DefaultConnectionString": "librame_data_default.db",
            "WritingConnectionString": "librame_data_writing.db"
        },
        // Test2: MySQL
        "DefaultTenant": {
            "Name": "DefaultTenant",
            "Host": "localhost",
            "EncryptedConnectionStrings": false,
            "DefaultConnectionString": "server=localhost;port=3306;database=librame_data_default;user=root;password=123456",
            "WritingConnectionString": "server=localhost;port=3306;database=librame_data_writing;user=root;password=123456",
            "WritingSeparation": true,
            "DataSynchronization": true,
            "StructureSynchronization": true
        },
        // Test3: SQL Server (default support)
        "DataBuilderDependency": {
            // DataBuilderOptions
            "Options": {
                "DefaultTenant": {
                    "Name": "DefaultTenant",
                    "Host": "localhost",
                    "DefaultConnectionString": "Data Source=.;Initial Catalog=librame_data_default;Integrated Security=True",
                    "WritingConnectionString": "Data Source=.;Initial Catalog=librame_data_writing;Integrated Security=True",
                    "WritingSeparation": true,
                    "DataSynchronization": true,
                    "StructureSynchronization": true
                }
            }
        }
    }

    //var root = new ConfigurationBuilder()
    //  .SetBasePath("BasePath")
    //  .AddJsonFile("appsettings.json")
    //  .Build();

    var builder = new ServiceCollection()
        .AddLibrame(dependency =>
        {
            // Default Support "appsettings.json"
            //dependency.ConfigurationRoot = root;
        });

### Use MySQL

    PM> Install-Package: Pomelo.EntityFrameworkCore.MySql

    var services = builder
        .AddLibrame(dependency =>
        {
            dependency.Options.Identifier.GuidIdentificationGenerator = CombIdentificationGenerator.MySQL;
        })
        .AddData(dependency =>
        {
            dependency.Options.IdentifierGenerator = CombIdentifierGenerator.MySQL;
            dependency.BindDefaultTenant(MySqlConnectionStringHelper.Validate);
        })
        .AddAccessor<TestDbContextAccessor>((tenant, optionsBuilder) =>
        {
            optionsBuilder.UseMySql(tenant.DefaultConnectionString, mySql =>
            {
                mySql.MigrationsAssembly(typeof(Program).GetAssemblyDisplayName());
                mySql.ServerVersion(new Version(5, 7, 28), ServerType.MySql);
            });
        })
        .AddDatabaseDesignTime<MySqlDesignTimeServices>()
        .AddStoreHub<TestStoreHub>()
        .AddStoreIdentifierGenerator<TestGuidStoreIdentifierGenerator>()
        .AddStoreInitializer<TestStoreInitializer>()
        .BuildServiceProvider();

### Use SQL Server

    PM> Install-Package: Microsoft.EntityFrameworkCore.SqlServer

    var services = builder
        .AddLibrame(dependency =>
        {
            // SQLServer (Default)
            //dependency.Options.Identifier.GuidIdentificationGenerator = CombIdentificationGenerator.SQLServer;
        })
        .AddData(dependency =>
        {
            dependency.Options.MigrationAssemblyReferences.Add(
                AssemblyReference.Load("Microsoft.EntityFrameworkCore.SqlServer"));
        })
        .AddAccessor<TestDbContextAccessor>((tenant, optionsBuilder) =>
        {
            optionsBuilder.UseSqlServer(tenant.DefaultConnectionString,
                sqlServer => sqlServer.MigrationsAssembly(typeof(Program).GetAssemblyDisplayName()));
        })
        .AddDatabaseDesignTime<SqlServerDesignTimeServices>()
        .AddStoreHub<TestStoreHub>()
        .AddStoreIdentifierGenerator<TestGuidStoreIdentifierGenerator>()
        .AddStoreInitializer<TestStoreInitializer>()
        .BuildServiceProvider();

### Use SQLite

    PM> Install-Package: Microsoft.EntityFrameworkCore.Sqlite

    var services = builder
        .AddLibrame(dependency =>
        {
            dependency.Options.Identifier.GuidIdentificationGenerator = CombIdentificationGenerator.SQLite;
        })
        .AddData(dependency =>
        {
            // ConnectionStrings Section is not support DefaultTenant.WritingSeparation
            dependency.Options.DefaultTenant.WritingSeparation = true;
            dependency.Options.DefaultTenant.DataSynchronization = true;
            dependency.Options.DefaultTenant.StructureSynchronization = true;
            
            dependency.BindConnectionStrings(dataFile => "Data Source=" + dependency.BaseDirectory.CombinePath(dataFile));
        })
        .AddAccessor<TestDbContextAccessor>((tenant, optionsBuilder) =>
        {
            optionsBuilder.UseSqlite(tenant.DefaultConnectionString,
                sqlite => sqlite.MigrationsAssembly(typeof(Program).GetAssemblyDisplayName()));
        })
        .AddDatabaseDesignTime<SqliteDesignTimeServices>()
        .AddStoreHub<TestStoreHub>()
        .AddStoreIdentifierGenerator<TestGuidStoreIdentifierGenerator>()
        .AddStoreInitializer<TestStoreInitializer>()
        .BuildServiceProvider();

### Create Models and Accessor

    //[Description("Article")]
    [ShardingTable]
    public class Article : AbstractEntityCreation<string>
    {
        public string Title { get; set; }
        public string Descr { get; set; }
        public int CategoryId { get; set; }
        public Category Category { get; set; }
    }

    //[Description("Category")]
    public class Category : AbstractEntityCreation<int>
    {
        public string Name { get; set; }

        public IList<Article> Articles { get; set; }
            = new List<Article>();
    }

    public class TestDbContextAccessor : DbContextAccessor
    {
        public TestDbContextAccessor(DbContextOptions options)
            : base(options)
        {
        }

        public DbSet<Category> Categories { get; set; }
        public DbSet<Article> Articles { get; set; }

        protected override void OnModelCreating(ModelBuilder modelBuilder)
        {
            base.OnModelCreating(modelBuilder);

            modelBuilder.Entity<Category>(b =>
            {
                b.ToTable();
                
                b.HasKey(x => x.Id);
                
                b.Property(x => x.Id).ValueGeneratedOnAdd();
                b.Property(x => x.Name).HasMaxLength(256).IsRequired();

                b.HasMany(x => x.Articles).WithOne(x => x.Category)
                    .IsRequired().OnDelete(DeleteBehavior.Cascade);
            });

            modelBuilder.Entity<Article>(b =>
            {
                b.ToTable(table =>
                {
                    // Sharding table by year (needs to add [ShardingTable] attribute on Article)
                    table.AppendYearSuffix(CurrentTimestamp);
                });

                b.HasKey(x => x.Id);

                b.Property(x => x.Id).HasMaxLength(256);
                b.Property(x => x.Title).HasMaxLength(256).IsRequired();
            });
        }
    }

### Create Stores

    public class TestGuidStoreIdentifierGenerator : GuidStoreIdentifierGenerator
    {
        public TestStoreIdentifier(IOptions<DataBuilderOptions> options,
            IClockService clock, ILoggerFactory loggerFactory)
            : base(options, clock, loggerFactory)
        {
        }
        
        public Task<Guid> GetArticleIdAsync(CancellationToken cancellationToken = default)
            => GenerateIdAsync("ArticleId", cancellationToken);
    }

    public class TestStoreInitializer : GuidStoreInitializer
    {
        // see tests/Librame.Extensions.Data.EntityFrameworkCore.Tests/TestStoreInitializer.cs
    }

    public class TestStoreHub : StoreHub<TestDbContextAccessor>
    {
        public TestStore(IStoreInitializer initializer, IAccessor accessor)
            : base(initializer, accessor)
        {
        }

        public IList<Category> GetCategories()
            => Accessor.Categories.ToList();

        public IPageable<Article> GetArticles()
            => Accessor.Articles.AsDescendingPagingByIndex(1, 10);

        public TestStoreHub UseWriteDbConnection()
        {
            Accessor.SwitchTenant(t => t.WritingConnectionString);
            return this;
        }

        public TestStoreHub UseDefaultDbConnection()
        {
            Accessor.SwitchTenant(t => t.DefaultConnectionString);
            return this;
        }
    }

    var stores = services.GetRequiredService<TestStoreHub>()
    var categories = stores.GetCategories();
    Assert.Empty(categories);

    categories = stores.UseWriteDbConnection().GetCategories();
    Assert.NotEmpty(categories);

    var articles = stores.UseDefaultDbConnection().GetArticles();
    Assert.Empty(articles);

    articles = stores.UseWriteDbConnection().GetArticles();
    Assert.True(articles.Total >= 0); // If enable sharding table, the articles table may be empty

### Tested Database

| Database     | Multi-Tenancy  | WritingSeparation  | Migration  | Audit  | Entity/Table Management  |
|------------  |--------------  |------------------  |----------  |------  |------------------------  |
| MySQL        | ✓              | ✓                  | ✓          | ✓      | ✓                        |
| SQL Server   | ✓              | ✓                  | ✓          | ✓      | ✓                        |
| SQLite       | ✓              | ✓                  | ✓          | ✓      | ✓                        |

**MySQL** [tested on MySQL 5.7](/examples/Librame.Extensions.Examples/Tested_in_MySQL57.png).

**SQL Server** [tested on SQL Server 2019](/examples/Librame.Extensions.Examples/Tested_in_SQLServer2019.png).

**SQLite** [tested on SQLite](/examples/Librame.Extensions.Examples/Tested_in_SQLite.png).
